rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Reusable Functions ---
    // Check if user is signed in
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is a member of the workspace
    // Document ID for members is `{userId}_{workspaceId}`
    function isWorkspaceMember(workspaceId) {
      return isAuthenticated() && exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + "_" + workspaceId));
    }

    // Check user's role in the workspace
    function getWorkspaceRole(workspaceId) {
      return get(/databases/$(database)/documents/workspace_members/$(request.auth.uid + "_" + workspaceId)).data.role;
    }

    // Check if the user is the owner of the workspace
    // Safe: checks exists() before get() to avoid null errors crashing the entire rule
    function isWorkspaceOwner(workspaceId) {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/workspaces/$(workspaceId))
        && get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.ownerId == request.auth.uid;
    }

    // Admin = member with 'admin' role OR workspace owner
    // Check member role first (cheaper, 1 read) before owner fallback (2 reads)
    function isWorkspaceAdmin(workspaceId) {
      return isAuthenticated() && (
        (isWorkspaceMember(workspaceId) && getWorkspaceRole(workspaceId) == 'admin')
        || isWorkspaceOwner(workspaceId)
      );
    }

    function isWorkspaceEditor(workspaceId) {
      return isAuthenticated() && (
        (isWorkspaceMember(workspaceId) && getWorkspaceRole(workspaceId) in ['admin', 'editor'])
        || isWorkspaceOwner(workspaceId)
      );
    }

    function isWorkspaceViewer(workspaceId) {
      return isAuthenticated() && (isWorkspaceMember(workspaceId) || isWorkspaceOwner(workspaceId));
    }

    // --- Rules by Collection ---

    // 1. Users Collection
    match /users/{userId} {
      // Users can only read and write their own profile
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // 2. Workspaces
    match /workspaces/{workspaceId} {
      // Members can read workspace details
      allow read: if isWorkspaceMember(workspaceId);
      // Only admins can update workspace settings
      allow write: if isWorkspaceAdmin(workspaceId);
      // Any authenticated user can create a workspace (they become owner)
      allow create: if isAuthenticated();
    }

    // 3. Workspace Members
    match /workspace_members/{memberId} {
      // Note: memberId format is `{userId}_{workspaceId}`
      // User can read their own membership, or members can read others in the same workspace
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        isWorkspaceMember(resource.data.workspaceId) ||
        (resource.data.status == 'invited' && resource.data.invitedEmail == request.auth.token.email)
      );
      
      // Admins can manage members. Users can accept invitations (create)
      allow create: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid || 
        isWorkspaceAdmin(request.resource.data.workspaceId)
      );

      allow update, delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        isWorkspaceAdmin(resource.data.workspaceId) ||
        (resource.data.status == 'invited' && resource.data.invitedEmail == request.auth.token.email)
      );
    }

    // 4. Multi-tenant Collections (Secured by workspaceId field)
    match /campaigns/{campaignId} {
      allow read: if isWorkspaceViewer(resource.data.workspaceId);
      allow create: if isWorkspaceEditor(request.resource.data.workspaceId);
      allow update, delete: if isWorkspaceEditor(resource.data.workspaceId);
      
      // Subcollections
      match /pillars/{pillarId} {
        allow read: if isWorkspaceViewer(get(/databases/$(database)/documents/campaigns/$(campaignId)).data.workspaceId);
        allow write: if isWorkspaceEditor(get(/databases/$(database)/documents/campaigns/$(campaignId)).data.workspaceId);
        
        match /angles/{angleId} {
          allow read: if isWorkspaceViewer(get(/databases/$(database)/documents/campaigns/$(campaignId)).data.workspaceId);
          allow write: if isWorkspaceEditor(get(/databases/$(database)/documents/campaigns/$(campaignId)).data.workspaceId);
        }
      }
    }

    match /contents/{contentId} {
      allow read: if isWorkspaceViewer(resource.data.workspaceId);
      allow create: if isWorkspaceEditor(request.resource.data.workspaceId);
      allow update, delete: if isWorkspaceEditor(resource.data.workspaceId);
    }

    match /schedules/{scheduleId} {
      allow read: if isWorkspaceViewer(resource.data.workspaceId);
      allow create: if isWorkspaceEditor(request.resource.data.workspaceId);
      allow update, delete: if isWorkspaceEditor(resource.data.workspaceId);
    }

    match /templates/{templateId} {
      allow read: if isWorkspaceViewer(resource.data.workspaceId);
      allow create: if isWorkspaceEditor(request.resource.data.workspaceId);
      allow update, delete: if isWorkspaceEditor(resource.data.workspaceId);
    }

    match /brands/{workspaceId} {
      allow read: if isWorkspaceViewer(workspaceId);
      allow create, update: if isWorkspaceEditor(workspaceId);
      allow delete: if isWorkspaceAdmin(workspaceId);
    }

    // 5. Connections (Platform credentials â€” per-user, NOT workspace-scoped)
    match /connections/{userId} {
      // Users can only read/write their own platform connections
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // 6. Conversions (Workspace-scoped conversion tracking)
    match /conversions/{convId} {
      allow read: if isWorkspaceViewer(resource.data.workspaceId);
      allow create: if isAuthenticated() && isWorkspaceEditor(request.resource.data.workspaceId);
      allow update, delete: if isWorkspaceEditor(resource.data.workspaceId);
    }

    // 7. Activity Logs
    match /activity_logs/{logId} {
      allow read: if isWorkspaceViewer(resource.data.workspaceId);
      // Fire-and-forget logging: any authenticated user with a valid workspaceId can create logs
      allow create: if isAuthenticated() && isWorkspaceViewer(request.resource.data.workspaceId);
      allow update, delete: if false; // Immutable audit trail
    }

    // 8. Mail (Firebase Extension "Trigger Email from Firestore")
    // Authenticated users can create mail documents to trigger invite emails.
    // The extension's service account handles read/delete server-side.
    match /mail/{mailId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if false;
    }

    // Block all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
